<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title><%= article.title %></title>
</head>
<body>
  <h1><%= article.title %></h1>
  <p><%= article.content %></p>
  <a href="/articles">Back to all articles</a>

  <% if (user && article.authorId && article.authorId._id.toString() === user._id.toString()) { %>
    <!-- Only author can see these -->
    <a href="/articles/edit/<%= article._id %>">Edit</a>
    <form action="/articles/delete/<%= article._id %>" method="POST" style="display:inline;">
      <button type="submit">Delete</button>
    </form>
  <% } %>

  <h2>Comments</h2>

  <% if (article.comments.length > 0) { %>
    <ul>
      <% article.comments.forEach(comment => { %>
        <li>
          <strong><%= comment.author ? comment.author.username : "Anonymous" %>:</strong>
          <%= comment.text %>

          <% if (user && comment.author && user._id.toString() === comment.author._id.toString()) { %>
            <!-- Edit -->
            <a href="/articles/<%= article._id %>/comments/<%= comment._id %>/edit">Edit</a>

            <!-- Delete -->
            <form action="/articles/<%= article._id %>/comments/<%= comment._id %>?_method=DELETE" 
                  method="POST" style="display:inline;">
              <button type="submit">Delete</button>
            </form>
          <% } %>
        </li>
      <% }) %>
    </ul>
  <% } else { %>
    <p>No comments yet.</p>
  <% } %>

  <% if (user) { %>
    <!-- Create comment -->
    <form action="/articles/<%= article._id %>/comments" method="POST">
      <textarea name="text" required></textarea>
      <br>
      <button type="submit">Add Comment</button>
    </form>
  <% } else { %>
    <p><a href="/users/login">Login</a> to add a comment.</p>
  <% } %>

  <hr>

  <!-- Reactions Part -->
  <h3>Reactions</h3>
  <% if (user) { %>
    <form action="/articles/<%= article._id %>/reactions" method="POST">
      <button type="submit" name="type" value="like">👍 Like</button>
      <button type="submit" name="type" value="love">❤️ Love</button>
      <button type="submit" name="type" value="dislike">👎 Dislike</button>
    </form>
  <% } else { %>
    <p><a href="/users/login">Login</a> to react.</p>
  <% } %>

  <p>
    👍: <%= article.reactions.filter(r => r.type === "like").length %> |
    ❤️: <%= article.reactions.filter(r => r.type === "love").length %> |
    👎: <%= article.reactions.filter(r => r.type === "dislike").length %>
  </p>

</body>
</html>
